{% extends 'base.html.twig' %}

{% block title %}Hello SortiesController!{% endblock %}

{% block body %}
    <div class="jumbotron mt-2">
        <h1 class="text-center display-4 lead">{{ page_name }}</h1>

        {% if form is defined and form is not empty %}
            {{ form_start(form) }}
                {{ form_errors(form) }}
                <div class="row">
                    <div class="col">
                        {{ form_row(form.lieu) }}
                        {{ form_row(form.start) }}
                        {{ form_row(form.close) }}
                       
                    </div>
                    <div class="col">
                        {{ form_row(form.ownorganisateur) }}
                        {{ form_row(form.subscibed) }}
                        {{ form_row(form.unsubscribed) }}
                        {{ form_row(form.passed) }}
                    </div>
                    <div class="col">
                        {{ form_row(form.submit) }}
                    </div>
                </div>
                {{ form_widget(form._token) }}
            {{ form_end(form) }}
        {% endif %}

        <table class="table table-striped table-bordered" style="width:100%">
            <thead class="thead-dark text-center">
            <tr>
                <th scope="col">Nom</th>
                <th scope="col">Début evenement</th>
                <th scope="col">Cloture inscription</th>
                <th scope="col">Inscrits/Places</th>
                <th scope="col">Inscrits</th>
                <th scope="col">Etat</th>
                <th scope="col">Organisateur</th>
                <th scope="col">Action</th>

            </tr>
            </thead>
            <tbody>

            {% if sorties is defined and sorties is not empty %}
                {% for sortie in sorties %}
                    {% set dateDebut = sortie.datedebut|date('Y-m-d') %}
                    {% set dateDifference = "now"|date('Y-m-d') %}
                    {% set dateEcart = date(dateDifference).diff(date(dateDebut))%}
                    {% if dateEcart.days >= 30 %}
                    {% else %}
                        {% set inscrit = false %}
                        {% for inscription in app.user.inscriptions %}
                            {% for inscriptions in sortie.inscriptions %}
                                {% if inscription == inscriptions %}
                                    {% set inscrit = true %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {% if subscibed and inscrit == false %}
                        {% else %}
                        <tr class="text-center">
                            <td scope="row">{{ sortie.nom }}</td>
                            <td scope="row">{{ sortie.datedebut|date('Y-m-d H:i:s')}}</td>
                            <td scope="row">{{ sortie.datecloture|date('Y-m-d') }}</td>
                            <td scope="row">{{ sortie.inscriptions|length }}/{{ sortie.nbinscriptionsmax }}</td>
                            <td scope="row" class="text-success">
                                {% if inscrit %}
                                    <i class="fas fa-check-circle"></i>
                                {% endif %}
                            </td>
                            <td scope="row">{{ sortie.etatsortie }}</td>
                            <td scope="row">{{ sortie.organisateur.prenom}} {{ sortie.organisateur.nom|slice(0, 1)}}.</td>
                            
                            <td scope="row" id="rowAction"><a href="{{ path('afficher_sortie', {'id': sortie.id}) }}" class="btn btn-outline-info"><i class="fas fa-info-circle"></i></a>

                                {% if app.user == sortie.organisateur or app.user.pseudo == "admin"%}
                                    <a href="{{ path('edit_sortie', {'id': sortie.id}) }}" class="btn btn-warning"><i class="far fa-edit"></i></a>
                                    <a href="{{ path('annuler_sortie', {'id': sortie.id}) }}" class="btn btn-danger"><i class="far fa-window-close"></i></a>
                                {% endif %}


                                {% if inscrit and sortie.datecloture|date('Y-m-d')>"now"|date('Y-m-d') %}
                                    <a id="desister" href="{{ path('remove_participant_sortie', {'id': sortie.id}) }}" class="btn btn-danger">Se désister <i class="fas fa-sign-in-alt"></i></a>
                                    <a id="inscrire" style="display:none" href="{{ path('edit_sortie', {'id': sortie.id}) }}" class="btn btn-success">S'inscrire <i class="fas fa-sign-in-alt"></i></a>
                                {% elseif sortie.inscriptions|length != sortie.nbinscriptionsmax and sortie.datecloture|date('Y-m-d')>"now"|date('Y-m-d') and sortie.etatsortie == "Ouvert"%}
                                    <a id="desister" style="display:none" href="{{ path('remove_participant_sortie', {'id': sortie.id}) }}" class="btn btn-danger">Se désister <i class="fas fa-sign-in-alt"></i></a>
                                    <a id="inscrire" href="{{ path('add_participant_sortie', {'id': sortie.id}) }}" class="btn btn-success">S'inscrire <i class="fas fa-sign-in-alt"></i></a>
                                {% else %}
                                {% endif %}

                            </td>
                        </tr>
                        {% endif %}
                        {% endif %}

                {% endfor %}
            {% else %}
                <tr class="text-center">
                    <th class="text-center text-muted" scope="row" colspan="7">No Sortie found...</th>
                </tr>
            {% endif %}
            </tbody>
        </table>
        <a href="{{ path('sortie_add') }}" class="btn btn-primary w-100 mt-4 mb-4">Add Sortie</a>

    </div>
{% endblock %}
